<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Your Password - Chartara Labs</title>
    <link rel="stylesheet" href="css/setup-pages.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="https://chartaralabs.io/brand_logo.png" alt="Chartara Labs" class="logo">
            <h1>Set Your Password</h1>
            <p class="subtitle">Complete your account setup to access Chartara Labs</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <p>Validating your setup link...</p>
        </div>

        <!-- Error State -->
        <div id="error-container" class="error-container" style="display: none;">
            <div class="error-icon">⚠️</div>
            <h2>Setup Link Invalid</h2>
            <p id="error-message">This setup link has expired or is invalid.</p>
            <div class="help-text">
                <p>Need help? Contact us at <a href="mailto:support@chartaralabs.com">support@chartaralabs.com</a></p>
            </div>
        </div>

        <!-- Setup Form -->
        <div id="setup-form" class="setup-container" style="display: none;">
            <div class="form-header">
                <h2>Create Your Password</h2>
                <p>Welcome! Please create a secure password for your account.</p>
                <p class="email-display">Account: <strong id="user-email"></strong></p>
            </div>

            <form id="password-form" class="password-form">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        minlength="8"
                        placeholder="Enter your new password"
                    >
                    <div class="password-requirements">
                        <p>Password must contain:</p>
                        <ul>
                            <li id="req-length">At least 8 characters</li>
                            <li id="req-uppercase">One uppercase letter</li>
                            <li id="req-lowercase">One lowercase letter</li>
                            <li id="req-number">One number</li>
                            <li id="req-special">One special character (!@#$%^&*)</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input 
                        type="password" 
                        id="confirm-password" 
                        name="confirm-password" 
                        required 
                        placeholder="Confirm your new password"
                    >
                    <div id="password-match" class="password-match"></div>
                </div>

                <button type="submit" id="submit-btn" class="submit-btn" disabled>
                    Set Password & Continue
                </button>
            </form>
        </div>

        <!-- Success State -->
        <div id="success-container" class="success-container" style="display: none;">
            <div class="success-icon">✅</div>
            <h2>Password Set Successfully!</h2>
            <p>Your account is now ready to use.</p>
            
            <div class="next-steps">
                <h3>Next Steps:</h3>
                <ol>
                    <li>Click the button below to access the app</li>
                    <li>Login with your email and new password</li>
                    <li>Start building your practice analytics!</li>
                </ol>
            </div>

            <a href="https://app.chartaralabs.io" class="app-btn">
                Access Chartara Labs App
            </a>

            <div class="help-text">
                <p>Questions? Contact us at <a href="mailto:support@chartaralabs.com">support@chartaralabs.com</a></p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                showError('No setup token provided in the URL.');
                return;
            }
            
            // Validate token
            validateToken(token);
        });

        // Password validation
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('submit-btn');

        passwordInput.addEventListener('input', validatePassword);
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        function validatePassword() {
            const password = passwordInput.value;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };

            // Update requirement indicators
            document.getElementById('req-length').className = requirements.length ? 'valid' : '';
            document.getElementById('req-uppercase').className = requirements.uppercase ? 'valid' : '';
            document.getElementById('req-lowercase').className = requirements.lowercase ? 'valid' : '';
            document.getElementById('req-number').className = requirements.number ? 'valid' : '';
            document.getElementById('req-special').className = requirements.special ? 'valid' : '';

            // Check if all requirements are met
            const allValid = Object.values(requirements).every(req => req);
            passwordInput.classList.toggle('valid', allValid);
            
            validatePasswordMatch();
            updateSubmitButton();
        }

        function validatePasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const matchDiv = document.getElementById('password-match');
            
            if (confirmPassword.length === 0) {
                matchDiv.textContent = '';
                confirmPasswordInput.classList.remove('valid', 'invalid');
                return;
            }
            
            if (password === confirmPassword) {
                matchDiv.textContent = '✓ Passwords match';
                matchDiv.className = 'password-match valid';
                confirmPasswordInput.classList.add('valid');
                confirmPasswordInput.classList.remove('invalid');
            } else {
                matchDiv.textContent = '✗ Passwords do not match';
                matchDiv.className = 'password-match invalid';
                confirmPasswordInput.classList.add('invalid');
                confirmPasswordInput.classList.remove('valid');
            }
            
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            const passwordValid = password.length >= 8 && 
                                /[A-Z]/.test(password) && 
                                /[a-z]/.test(password) && 
                                /\d/.test(password) && 
                                /[!@#$%^&*]/.test(password);
            
            const passwordsMatch = password === confirmPassword && confirmPassword.length > 0;
            
            submitBtn.disabled = !(passwordValid && passwordsMatch);
        }

        // Form submission
        document.getElementById('password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const password = document.getElementById('password').value;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Setting Password...';
            
            setPassword(token, password);
        });

        // API functions
        async function validateToken(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/validate-token?token=${token}`);
                const data = await response.json();
                
                if (data.valid) {
                    document.getElementById('user-email').textContent = data.email;
                    showSetupForm();
                } else {
                    showError(data.error || 'Invalid setup token');
                }
            } catch (error) {
                showError('Failed to validate setup token. Please check your internet connection.');
            }
        }

        async function setPassword(token, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/set-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showSuccess();
                } else {
                    showError(data.error || 'Failed to set password');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Set Password & Continue';
                }
            } catch (error) {
                showError('Failed to set password. Please check your internet connection.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Set Password & Continue';
            }
        }

        // UI state functions
        function showSetupForm() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('setup-form').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'block';
        }

        function showSuccess() {
            document.getElementById('setup-form').style.display = 'none';
            document.getElementById('success-container').style.display = 'block';
        }
    </script>
</body>
</html>
